<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UGA FUN</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%2346178f'/%3E%3Ctext x='50' y='75' font-family='sans-serif' font-size='60' font-weight='900' fill='white' text-anchor='middle'%3E?%3C/text%3E%3C/svg%3E">

    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVUdBIEZVTiIsImNob3J0X25hbWUiOiJVR0EgRlVOIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiM0NjE3OGYiLCJ0aGVtZV9jb2xvciI6IiM0NjE3OGYiLCJpY29ucyI6W3sic3JjIjoiaHR0cHM6Ly9jZG4tY29ucy1wbmcuZmxhdGljb24uY29tLzUxMi8yMzczLzIzNzM2NDQucG5nIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">
    <meta name="theme-color" content="#46178f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- QRCode.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <!-- HTML5-QRCode -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Montserrat', 'sans-serif'],
                    },
                    colors: {
                        uga: {
                            purple: '#46178f',
                            blue: '#1368ce',
                            green: '#26890c',
                            red: '#e21b3c',
                            yellow: '#ffa602',
                            dark: '#333333'
                        }
                    },
                    boxShadow: {
                        '3d': '0 10px 0px 0px rgba(0,0,0,0.2)',
                        '3d-hover': '0 5px 0px 0px rgba(0,0,0,0.2)',
                    },
                    animation: {
                        'float': 'float 8s ease-in-out infinite',
                        'gradient': 'gradient 20s ease infinite',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0) rotate(0deg)' },
                            '50%': { transform: 'translateY(-20px) rotate(5deg)' },
                        },
                        gradient: {
                            '0%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' },
                            '100%': { backgroundPosition: '0% 50%' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #f2f2f2;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        /* Dynamic Background */
        .bg-dynamic {
            background: linear-gradient(-45deg, #46178f, #1368ce, #26890c, #e21b3c);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        .floating-shape {
            position: absolute;
            opacity: 0.15;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(5px);
            z-index: 0;
            pointer-events: none;
        }

        /* Glassmorphism containers */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        /* 3D Podium */
        .podium-bar {
            transform-style: preserve-3d;
            position: relative;
        }
        .podium-bar::before {
            content: '';
            position: absolute;
            top: 0; left: 100%; width: 20px; height: 100%;
            background: rgba(0,0,0,0.2);
            transform: skewY(45deg);
            transform-origin: 0 0;
        }
        .podium-bar::after {
            content: '';
            position: absolute;
            top: -20px; left: 0; width: 100%; height: 20px;
            background: rgba(255,255,255,0.2);
            transform: skewX(45deg);
            transform-origin: 0 100%;
        }

        .screen { display: none; width: 100%; height: 100vh; flex-direction: column; }
        .screen.active { display: flex; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }

        .answer-card:active { transform: scale(0.95); }
        #reader { width: 100%; }
        
        .shape-circle { border-radius: 50%; }
        .shape-square { border-radius: 10%; }
        .shape-triangle { clip-path: polygon(50% 0%, 0% 100%, 100% 100%); background: white !important; }

        .stat-bar {
            transition: height 1s ease-out;
            height: 0%;
        }
    </style>
</head>
<body class="text-uga-dark select-none font-sans">

    <!-- AUDIO SOURCES -->
    <audio id="bgm-menu" loop crossorigin="anonymous"><source src="https://assets.mixkit.co/music/preview/mixkit-summer-fun-13.mp3" type="audio/mp3"></audio>
    <audio id="bgm-game" loop crossorigin="anonymous"><source src="https://assets.mixkit.co/music/preview/mixkit-tech-house-vibes-133.mp3" type="audio/mp3"></audio>
    <audio id="bgm-podium" crossorigin="anonymous"><source src="https://assets.mixkit.co/music/preview/mixkit-winning-chimes-201.mp3" type="audio/mp3"></audio>
    <audio id="sfx-correct" crossorigin="anonymous"><source src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.wav" type="audio/wav"></audio>
    <audio id="sfx-wrong" crossorigin="anonymous"><source src="https://assets.mixkit.co/sfx/preview/mixkit-wrong-answer-fail-notification-946.wav" type="audio/wav"></audio>

    <!-- BACKGROUND -->
    <div id="bg-layer" class="fixed inset-0 bg-dynamic z-[-1]"></div>
    <div id="shapes-layer" class="fixed inset-0 z-[-1] overflow-hidden"></div>

    <!-- FULLSCREEN QR MODAL -->
    <div id="qr-modal" class="hidden fixed inset-0 z-[9999] bg-black/90 flex items-center justify-center p-10" onclick="this.classList.add('hidden')">
        <div id="qr-large" class="bg-white p-6 rounded-3xl"></div>
    </div>

    <!-- EMOJI PICKER MODAL -->
    <div id="emoji-modal" class="hidden fixed inset-0 z-[9999] bg-black/60 backdrop-blur-sm flex items-end md:items-center justify-center p-4">
        <div class="bg-white w-full max-w-2xl rounded-t-3xl md:rounded-3xl p-6 h-[80vh] flex flex-col shadow-2xl animate-in slide-in-from-bottom-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-black text-uga-dark">Pick an Avatar</h3>
                <button onclick="document.getElementById('emoji-modal').classList.add('hidden')" class="text-gray-400 hover:text-black text-2xl">‚úï</button>
            </div>
            <div id="emoji-grid" class="flex-1 overflow-y-auto grid grid-cols-5 md:grid-cols-8 gap-2 p-2">
                <!-- Emojis injected here -->
            </div>
        </div>
    </div>

    <!-- EDIT PROFILE MODAL -->
    <div id="edit-profile-modal" class="hidden fixed inset-0 z-[9990] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md p-6 rounded-3xl shadow-2xl">
            <h3 class="text-2xl font-black mb-6 text-center">Edit Profile</h3>
            <input type="text" id="edit-nick-input" placeholder="Nickname" maxlength="12" class="w-full bg-gray-100 text-center font-bold text-xl py-3 rounded-xl mb-6 border-2 border-gray-200 focus:border-uga-dark outline-none">
            
            <div class="flex justify-center items-center gap-4 mb-6">
                <div onclick="app.openEmojiPicker('edit')" id="edit-emoji-preview" class="w-24 h-24 rounded-full flex items-center justify-center text-5xl bg-red-200 shadow-inner border-4 border-gray-100 cursor-pointer hover:scale-105 transition">üê∂</div>
            </div>
            
            <div class="flex justify-center gap-3 mb-8">
                <div onclick="app.setEditColor('bg-red-200')" class="w-8 h-8 rounded-full bg-red-200 border-2 border-transparent hover:border-black cursor-pointer shadow-sm"></div>
                <div onclick="app.setEditColor('bg-blue-200')" class="w-8 h-8 rounded-full bg-blue-200 border-2 border-transparent hover:border-black cursor-pointer shadow-sm"></div>
                <div onclick="app.setEditColor('bg-green-200')" class="w-8 h-8 rounded-full bg-green-200 border-2 border-transparent hover:border-black cursor-pointer shadow-sm"></div>
                <div onclick="app.setEditColor('bg-yellow-200')" class="w-8 h-8 rounded-full bg-yellow-200 border-2 border-transparent hover:border-black cursor-pointer shadow-sm"></div>
                <div onclick="app.setEditColor('bg-purple-200')" class="w-8 h-8 rounded-full bg-purple-200 border-2 border-transparent hover:border-black cursor-pointer shadow-sm"></div>
            </div>

            <div class="flex gap-3">
                <button onclick="document.getElementById('edit-profile-modal').classList.add('hidden')" class="flex-1 bg-gray-200 text-gray-700 font-bold py-3 rounded-xl">Cancel</button>
                <button onclick="app.saveProfileChanges()" class="flex-1 bg-uga-green text-white font-bold py-3 rounded-xl shadow-lg">Save</button>
            </div>
        </div>
    </div>

    <!-- SCREEN: HOME -->
    <div id="screen-home" class="screen active items-center justify-center text-white relative">
        <h1 class="text-6xl md:text-8xl font-black mb-2 tracking-tighter drop-shadow-lg z-10 animate-float">UGA FUN</h1>
        <p class="text-xl md:text-2xl mb-12 font-bold opacity-90 z-10 shadow-black">The P2P Quiz Game</p>

        <div class="flex flex-col gap-4 w-full max-w-xs z-10">
            <button onclick="app.showJoinScreen()" class="glass-panel text-uga-purple font-black py-5 rounded-xl shadow-3d hover:shadow-3d-hover hover:-translate-y-1 transition text-xl">JOIN GAME</button>
            <button onclick="app.showLibrary()" class="bg-uga-blue text-white font-black py-5 rounded-xl shadow-3d hover:shadow-3d-hover hover:-translate-y-1 transition text-xl border-b-4 border-blue-800">QUIZ LIBRARY</button>
            <button onclick="app.showCreate()" class="bg-uga-green text-white font-black py-5 rounded-xl shadow-3d hover:shadow-3d-hover hover:-translate-y-1 transition text-xl border-b-4 border-green-800">CREATE QUIZ</button>
            <button onclick="app.showTransferMenu()" class="bg-uga-yellow text-white font-black py-5 rounded-xl shadow-3d hover:shadow-3d-hover hover:-translate-y-1 transition text-xl border-b-4 border-yellow-600">TRANSFER QUIZ</button>
        </div>
    </div>

    <!-- SCREEN: TRANSFER MENU -->
    <div id="screen-transfer-menu" class="screen items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-8 rounded-2xl shadow-2xl relative">
            <button onclick="app.goHome()" class="absolute top-4 left-4 text-gray-500 font-bold hover:text-black">‚Üê Back</button>
            <h2 class="text-center font-black text-3xl mb-8 text-uga-dark">TRANSFER QUIZ</h2>
            
            <div class="grid grid-cols-2 gap-6">
                <button onclick="app.setupSender()" class="bg-uga-blue text-white p-6 rounded-2xl font-bold shadow-lg hover:scale-105 transition flex flex-col items-center">
                    <span class="text-5xl mb-3">üì§</span>
                    <span class="tracking-widest">SEND</span>
                </button>
                <button onclick="app.setupReceiver()" class="bg-uga-green text-white p-6 rounded-2xl font-bold shadow-lg hover:scale-105 transition flex flex-col items-center">
                    <span class="text-5xl mb-3">üì•</span>
                    <span class="tracking-widest">RECEIVE</span>
                </button>
            </div>
        </div>
    </div>

    <!-- SCREEN: TRANSFER SENDER -->
    <div id="screen-transfer-sender" class="screen items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-6 rounded-2xl shadow-2xl flex flex-col items-center">
             <button onclick="app.goHome()" class="self-start text-gray-400 font-bold mb-2">Cancel</button>
            <h2 class="font-black text-2xl mb-4 text-uga-purple">Pick a Quiz to Send</h2>
            <div id="transfer-quiz-list" class="w-full max-h-80 overflow-y-auto mb-4 border rounded-xl bg-gray-50/50"></div>
            <div id="sender-status" class="hidden flex flex-col items-center w-full animate-in fade-in zoom-in">
                <div class="bg-white p-4 rounded-xl shadow-inner mb-4"><div id="transfer-qrcode"></div></div>
                <p class="font-bold mb-2 text-gray-600">Scan or enter code:</p>
                <div id="transfer-code-display" class="text-5xl font-black text-uga-blue tracking-widest bg-gray-100 px-8 py-4 rounded-xl shadow-inner border-2 border-gray-200">----</div>
                <p class="mt-4 animate-pulse text-sm font-bold text-uga-green flex items-center gap-2"><span class="w-2 h-2 bg-uga-green rounded-full"></span> Waiting for receiver...</p>
            </div>
        </div>
    </div>

    <!-- SCREEN: TRANSFER RECEIVER -->
    <div id="screen-transfer-receiver" class="screen items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-6 rounded-2xl shadow-2xl text-center">
            <button onclick="app.goHome()" class="float-left text-gray-400 font-bold">Cancel</button>
            <h2 class="font-black text-2xl mb-6 text-uga-dark">RECEIVE QUIZ</h2>
            <input type="number" id="transfer-code-input" placeholder="4-Digit Code" class="w-full bg-gray-50 text-center font-bold text-4xl py-4 rounded-xl mb-4 border-2 border-gray-200 focus:border-uga-dark outline-none transition-colors">
            <button onclick="app.connectToSender()" class="w-full bg-uga-dark text-white font-bold py-4 rounded-xl shadow-lg mb-6 hover:scale-[1.02] transition">CONNECT</button>
            <div class="relative mb-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center text-sm"><span class="px-4 bg-white rounded-full text-gray-500 font-bold border border-gray-200">OR</span></div></div>
            <button onclick="app.startTransferScanner()" class="w-full border-2 border-uga-dark text-uga-dark font-bold py-3 rounded-xl hover:bg-gray-50 transition">üì∑ Scan QR Code</button>
            <div id="transfer-reader" class="mt-4 w-full rounded-lg overflow-hidden"></div>
        </div>
    </div>

    <!-- SCREEN: CREATE/EDIT QUIZ -->
    <div id="screen-create" class="screen">
        <div class="glass-panel p-4 shadow-md flex justify-between items-center sticky top-0 z-50 rounded-b-xl mx-2 mt-2">
            <button onclick="app.goHome()" class="font-bold text-gray-500 hover:text-gray-800 pl-4">Exit</button>
            <h2 class="font-bold text-xl text-uga-purple" id="create-screen-title">Create New Quiz</h2>
            <button onclick="app.saveQuiz()" class="bg-uga-green text-white px-6 py-2 rounded-lg font-bold shadow hover:bg-green-600 transition">Save</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 max-w-3xl mx-auto w-full pb-20">
            <input type="text" id="quiz-title-input" placeholder="Enter Quiz Title..." class="glass-panel w-full text-3xl font-bold border-b-4 border-gray-300 focus:border-uga-purple outline-none mb-6 py-4 px-6 rounded-xl placeholder-gray-400 text-uga-dark">
            <div id="questions-container" class="space-y-6"></div>
            <button onclick="app.addQuestionUI()" class="w-full py-6 mt-6 border-4 border-dashed border-white/50 bg-white/20 text-white font-bold rounded-xl hover:bg-white/30 transition text-lg backdrop-blur-sm">+ Add Question</button>
        </div>
    </div>

    <!-- SCREEN: LIBRARY -->
    <div id="screen-library" class="screen">
        <div class="glass-panel p-4 shadow-md flex justify-between items-center sticky top-0 z-50 rounded-b-xl mx-2 mt-2">
            <button onclick="app.goHome()" class="font-bold text-gray-500 hover:text-gray-800 pl-4">‚Üê Back</button>
            <h2 class="font-bold text-xl text-uga-blue">My Library</h2>
            <div class="w-10"></div>
        </div>
        <div id="library-list" class="p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-6xl mx-auto w-full"></div>
    </div>

    <!-- SCREEN: HOST LOBBY -->
    <div id="screen-host-lobby" class="screen relative">
        <div class="absolute top-4 right-4 text-right z-20 bg-black/20 p-4 rounded-xl backdrop-blur-md text-white">
            <h3 class="font-bold opacity-80 mb-2 border-b border-white/20 pb-1">Settings</h3>
            <label class="flex items-center justify-end gap-2 cursor-pointer mb-2"><span class="text-sm font-bold">Show Qs on Phones</span><input type="checkbox" id="setting-show-q" class="w-5 h-5 accent-uga-green rounded"></label>
            <label class="flex items-center justify-end gap-2 cursor-pointer"><span class="text-sm font-bold">Show Ans on Phones</span><input type="checkbox" id="setting-show-a" class="w-5 h-5 accent-uga-green rounded"></label>
        </div>
        <div class="flex flex-col items-center mt-12 mb-6 z-10">
            <div class="glass-panel p-3 rounded-2xl shadow-2xl mb-4 transform hover:scale-105 transition duration-500 cursor-pointer" onclick="app.toggleLargeQr()"><div id="qrcode"></div><p class="text-center text-xs font-bold text-gray-400 mt-1">Click to enlarge</p></div>
            <div class="text-2xl font-bold text-white drop-shadow-md mb-2">Join at <span class="text-uga-yellow font-black text-3xl" id="host-url-display">domain.com</span></div>
            <div class="flex items-center gap-4 bg-white/90 text-uga-dark px-8 py-3 rounded-full shadow-lg backdrop-blur transform hover:scale-105 transition">
                <span class="font-bold text-gray-500 uppercase tracking-widest text-sm">Game PIN</span><span class="font-black text-5xl tracking-widest text-uga-dark" id="game-pin-display">------</span>
            </div>
        </div>
        <div class="flex-1 p-4 w-full max-w-6xl mx-auto overflow-y-auto pb-24 z-10">
            <div class="flex justify-between items-end mb-4 border-b border-white/20 pb-2">
                <span class="font-bold text-xl text-white drop-shadow" id="player-count">0 Players</span>
                <div class="flex gap-2">
                    <button onclick="app.goHome()" class="bg-red-500/20 hover:bg-red-500/40 text-white px-6 py-2 rounded-lg font-bold backdrop-blur">Abort</button>
                    <button onclick="app.startHostedGame()" id="start-btn" class="bg-uga-dark text-white px-10 py-3 rounded-lg shadow-xl font-bold opacity-50 cursor-not-allowed transition text-lg border-b-4 border-black">Start Game</button>
                </div>
            </div>
            <div id="host-player-grid" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3"></div>
        </div>
        <div class="absolute bottom-0 left-0 w-full bg-uga-dark/95 text-white p-3 flex justify-between items-center px-8 backdrop-blur z-50 border-t border-white/10">
            <span class="font-bold opacity-50">UGA FUN HOST</span>
            <div class="font-bold text-xl">PIN: <span id="footer-pin" class="text-uga-yellow"></span></div>
        </div>
    </div>

    <!-- SCREEN: PLAYER JOIN -->
    <div id="screen-join" class="screen items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-8 rounded-3xl shadow-2xl relative">
            <button onclick="app.goHome()" class="absolute top-6 left-6 text-gray-400 font-bold hover:text-black">‚Üê</button>
            <h2 class="text-center font-black text-4xl mb-8 text-uga-dark tracking-tight">JOIN GAME</h2>
            <div id="join-step-1">
                <input type="number" id="pin-input" placeholder="Game PIN" class="w-full bg-gray-50 text-center font-bold text-3xl py-5 rounded-xl mb-6 border-2 border-gray-200 focus:border-uga-dark outline-none transition-all shadow-inner">
                <button onclick="app.validatePin()" class="w-full bg-uga-dark text-white font-bold py-5 rounded-xl shadow-lg hover:-translate-y-1 hover:shadow-xl transition mb-6 text-lg">ENTER</button>
                <div class="relative mb-6"><div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div><div class="relative flex justify-center text-sm"><span class="px-4 bg-white rounded-full text-gray-500 font-bold border border-gray-200 shadow-sm">OR</span></div></div>
                <button onclick="app.startScanner()" class="w-full border-2 border-uga-dark text-uga-dark font-bold py-4 rounded-xl flex items-center justify-center gap-3 hover:bg-uga-dark hover:text-white transition"><span class="text-2xl">üì∑</span> Scan QR Code</button>
                <div id="scanner-container" class="hidden mt-4 bg-black rounded-xl overflow-hidden shadow-lg"><div id="reader"></div><button onclick="app.stopScanner()" class="w-full bg-red-500 text-white py-3 font-bold">Cancel Scan</button></div>
            </div>
            <div id="join-step-2" class="hidden">
                <input type="text" id="nickname-input" placeholder="Nickname" maxlength="12" class="w-full bg-gray-50 text-center font-bold text-2xl py-4 rounded-xl mb-6 border-2 border-gray-200 focus:border-uga-dark outline-none shadow-inner">
                <div class="mb-8">
                    <p class="text-center font-bold text-gray-500 mb-4 uppercase tracking-widest text-xs">Select Avatar</p>
                    <div class="flex justify-center items-center gap-6">
                        <div onclick="app.openEmojiPicker('join')" id="emoji-preview" class="w-24 h-24 rounded-full flex items-center justify-center text-5xl bg-red-200 shadow-inner border-4 border-white cursor-pointer hover:scale-105 transition relative">
                            üê∂
                            <div class="absolute bottom-0 right-0 bg-white rounded-full p-1 shadow text-xs">‚úèÔ∏è</div>
                        </div>
                    </div>
                    <div class="flex justify-center gap-3 mt-4">
                        <div onclick="app.setJoinColor('bg-red-200')" class="w-8 h-8 rounded-full bg-red-200 border-2 border-transparent hover:border-black cursor-pointer shadow-sm"></div>
                        <div onclick="app.setJoinColor('bg-blue-200')" class="w-8 h-8 rounded-full bg-blue-200 border-2 border-transparent hover:border-black cursor-pointer shadow-sm"></div>
                        <div onclick="app.setJoinColor('bg-green-200')" class="w-8 h-8 rounded-full bg-green-200 border-2 border-transparent hover:border-black cursor-pointer shadow-sm"></div>
                        <div onclick="app.setJoinColor('bg-yellow-200')" class="w-8 h-8 rounded-full bg-yellow-200 border-2 border-transparent hover:border-black cursor-pointer shadow-sm"></div>
                        <div onclick="app.setJoinColor('bg-purple-200')" class="w-8 h-8 rounded-full bg-purple-200 border-2 border-transparent hover:border-black cursor-pointer shadow-sm"></div>
                    </div>
                </div>
                <button id="join-lobby-btn" onclick="app.joinLobby()" class="w-full bg-uga-green text-white font-black py-5 rounded-xl shadow-3d hover:shadow-3d-hover hover:translate-y-1 transition text-xl border-b-4 border-green-800">READY TO GO!</button>
            </div>
        </div>
    </div>

    <!-- SCREEN: PLAYER WAITING -->
    <div id="screen-player-wait" class="screen items-center justify-center text-white p-4">
        <div class="text-center z-10 flex flex-col items-center">
            <h2 class="text-5xl font-black mb-6 animate-bounce drop-shadow-lg">You're in!</h2>
            <div class="glass-panel text-uga-dark px-8 py-6 rounded-3xl mb-8 flex flex-col items-center">
                <div id="wait-avatar-display" class="w-24 h-24 rounded-full bg-gray-200 flex items-center justify-center text-5xl mb-3 shadow-lg">?</div>
                <p class="font-black text-2xl mb-1" id="wait-name-display">Player</p>
                <p class="font-bold text-sm opacity-60 mb-4">Waiting for host...</p>
                <button onclick="app.openEditProfile()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg font-bold text-sm transition">‚úèÔ∏è Edit Profile</button>
            </div>
            <div class="loader text-6xl animate-pulse">‚è≥</div>
        </div>
    </div>

    <!-- SCREEN: GAME (HOST) - FIXED -->
    <div id="screen-game-host" class="screen flex-col">
        <div class="glass-panel p-4 shadow-sm flex justify-between items-center text-xl font-bold text-gray-600 pl-8 m-4 rounded-xl">
            <span id="host-q-index">1 / 10</span>
            <div class="flex items-center gap-4">
                 <button onclick="app.endRound()" class="bg-white hover:bg-gray-50 text-uga-blue border-2 border-uga-blue text-sm px-6 py-2 rounded-full font-bold shadow-sm transition">Skip</button>
                <span id="host-answers-count" class="bg-uga-dark text-white px-4 py-2 rounded-lg text-sm shadow">0 Answers</span>
            </div>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center p-4 text-center overflow-y-auto z-10">
            <div id="host-q-image-container" class="mb-6 hidden transform hover:scale-105 transition"><img id="host-q-image" src="" class="max-h-64 rounded-xl shadow-2xl object-contain bg-white p-2"></div>
            <div class="glass-panel p-8 rounded-2xl shadow-xl w-full max-w-5xl mb-8 border-l-8 border-uga-purple"><h2 id="host-q-text" class="text-3xl md:text-5xl font-black leading-tight break-words text-uga-dark">Question?</h2></div>
            <div class="flex items-center gap-4 mb-8"><div class="w-24 h-24 rounded-full bg-uga-purple text-white flex items-center justify-center font-black text-4xl shadow-2xl border-8 border-white/20 animate-pulse-slow" id="host-timer-circle">20</div></div>
            
            <!-- Answers Grid (FIXED: NO JS IN HTML) -->
            <div class="grid grid-cols-2 gap-6 w-full max-w-6xl h-48 md:h-64">
                <div id="h-opt-0" class="glass-panel !bg-uga-red/90 !border-none rounded-xl flex items-center p-6 text-white font-bold text-2xl shadow-lg relative overflow-hidden">
                    <div id="stat-bar-0" class="absolute bottom-0 left-0 w-full bg-black/30 stat-bar z-0"></div>
                    <div class="relative z-10 flex justify-between w-full items-center">
                        <div class="flex items-center"><span class="mr-6 text-4xl">‚ñ≤</span><span class="opt-text text-left text-shadow">Option 1</span></div>
                        <div id="stat-text-0" class="hidden text-right"><div class="text-3xl font-black" id="stat-percent-0">0%</div><div class="text-sm opacity-80" id="stat-count-0">0 votes</div></div>
                    </div>
                </div>
                <div id="h-opt-1" class="glass-panel !bg-uga-blue/90 !border-none rounded-xl flex items-center p-6 text-white font-bold text-2xl shadow-lg relative overflow-hidden">
                    <div id="stat-bar-1" class="absolute bottom-0 left-0 w-full bg-black/30 stat-bar z-0"></div>
                    <div class="relative z-10 flex justify-between w-full items-center">
                        <div class="flex items-center"><span class="mr-6 text-4xl">‚óÜ</span><span class="opt-text text-left text-shadow">Option 2</span></div>
                        <div id="stat-text-1" class="hidden text-right"><div class="text-3xl font-black" id="stat-percent-1">0%</div><div class="text-sm opacity-80" id="stat-count-1">0 votes</div></div>
                    </div>
                </div>
                <div id="h-opt-2" class="glass-panel !bg-uga-yellow/90 !border-none rounded-xl flex items-center p-6 text-white font-bold text-2xl shadow-lg relative overflow-hidden">
                    <div id="stat-bar-2" class="absolute bottom-0 left-0 w-full bg-black/30 stat-bar z-0"></div>
                    <div class="relative z-10 flex justify-between w-full items-center">
                        <div class="flex items-center"><span class="mr-6 text-4xl">‚óè</span><span class="opt-text text-left text-shadow">Option 3</span></div>
                        <div id="stat-text-2" class="hidden text-right"><div class="text-3xl font-black" id="stat-percent-2">0%</div><div class="text-sm opacity-80" id="stat-count-2">0 votes</div></div>
                    </div>
                </div>
                <div id="h-opt-3" class="glass-panel !bg-uga-green/90 !border-none rounded-xl flex items-center p-6 text-white font-bold text-2xl shadow-lg relative overflow-hidden">
                    <div id="stat-bar-3" class="absolute bottom-0 left-0 w-full bg-black/30 stat-bar z-0"></div>
                    <div class="relative z-10 flex justify-between w-full items-center">
                        <div class="flex items-center"><span class="mr-6 text-4xl">‚ñ†</span><span class="opt-text text-left text-shadow">Option 4</span></div>
                        <div id="stat-text-3" class="hidden text-right"><div class="text-3xl font-black" id="stat-percent-3">0%</div><div class="text-sm opacity-80" id="stat-count-3">0 votes</div></div>
                    </div>
                </div>
            </div>
            <button id="host-next-btn" onclick="app.nextRound()" class="hidden mt-8 bg-uga-blue text-white px-12 py-4 rounded-full font-black shadow-2xl hover:scale-110 transition text-2xl border-4 border-white/20 z-50">Next</button>
        </div>
        <div class="w-full bg-uga-dark/95 text-white p-3 flex justify-between items-center px-8 text-sm backdrop-blur z-50"><span>UGA FUN</span><span>PIN: <span id="footer-pin-game" class="text-uga-yellow font-bold"></span></span></div>
    </div>

    <!-- SCREEN: GAME (PLAYER) -->
    <div id="screen-game-player" class="screen flex-col">
        <div id="player-view-content" class="glass-panel p-4 text-center hidden shadow-sm border-b-4 border-white/30 m-4 rounded-xl">
            <img id="player-q-image" src="" class="hidden max-h-40 mx-auto mb-2 rounded-lg object-contain shadow-md">
            <h3 id="player-q-text" class="font-bold text-xl leading-tight text-uga-dark"></h3>
        </div>
        <div id="player-view-wait" class="hidden flex-1 flex flex-col items-center justify-center text-white p-6 text-center">
            <h1 class="text-4xl font-black mb-4 drop-shadow-lg">Eyes on the screen!</h1>
            <div class="w-20 h-20 border-8 border-white border-t-transparent rounded-full animate-spin shadow-lg"></div>
        </div>
        <div id="player-view-options" class="flex-1 grid grid-cols-2 grid-rows-2 h-full gap-3 p-3 pb-24">
            <button onclick="app.submitAnswer(0)" id="p-btn-0" class="answer-card glass-panel !bg-uga-red/90 rounded-xl flex flex-col items-center justify-center shadow-lg active:scale-95 transition"><div class="w-0 h-0 border-l-[20px] border-l-transparent border-r-[20px] border-r-transparent border-b-[35px] border-b-white mb-2 filter drop-shadow"></div><span class="p-opt-text text-white font-bold text-lg px-2 hidden"></span></button>
            <button onclick="app.submitAnswer(1)" id="p-btn-1" class="answer-card glass-panel !bg-uga-blue/90 rounded-xl flex flex-col items-center justify-center shadow-lg active:scale-95 transition"><div class="w-10 h-10 bg-white transform rotate-45 mb-2 filter drop-shadow"></div><span class="p-opt-text text-white font-bold text-lg px-2 hidden"></span></button>
            <button onclick="app.submitAnswer(2)" id="p-btn-2" class="answer-card glass-panel !bg-uga-yellow/90 rounded-xl flex flex-col items-center justify-center shadow-lg active:scale-95 transition"><div class="w-12 h-12 bg-white rounded-full mb-2 filter drop-shadow"></div><span class="p-opt-text text-white font-bold text-lg px-2 hidden"></span></button>
            <button onclick="app.submitAnswer(3)" id="p-btn-3" class="answer-card glass-panel !bg-uga-green/90 rounded-xl flex flex-col items-center justify-center shadow-lg active:scale-95 transition"><div class="w-10 h-10 bg-white mb-2 filter drop-shadow"></div><span class="p-opt-text text-white font-bold text-lg px-2 hidden"></span></button>
        </div>
        <div id="player-view-result" class="hidden fixed inset-0 z-50 flex-col items-center justify-center text-white p-4">
            <div class="flex-1 w-full flex flex-col items-center justify-center gap-6 animate-in zoom-in duration-300">
                <h1 id="p-res-title" class="text-6xl font-black tracking-tight drop-shadow-lg">CORRECT</h1>
                <div class="flex flex-col items-center bg-black/30 p-8 rounded-3xl w-full max-w-sm backdrop-blur-md shadow-2xl border border-white/20"><p class="text-xl font-bold opacity-80 mb-2 uppercase tracking-widest">Score</p><p id="p-res-score" class="text-6xl font-black">+ 0</p></div>
                <div class="flex items-center gap-3 bg-white/20 px-8 py-4 rounded-full backdrop-blur shadow-lg"><span class="text-3xl">üî•</span><span id="p-res-streak" class="text-3xl font-bold">Streak: 0</span></div>
            </div>
            <div class="pb-10 opacity-70 font-bold text-center animate-pulse">Waiting for host...</div>
        </div>
        <div id="player-game-over" class="hidden fixed inset-0 z-50 bg-uga-purple text-white flex flex-col items-center justify-center p-6">
            <h1 class="text-5xl font-black mb-8 drop-shadow-lg">Game Over</h1>
            <div class="bg-white/10 p-10 rounded-full mb-10 backdrop-blur-md shadow-2xl"><p class="text-3xl font-bold" id="p-final-rank">You placed #?</p></div>
            <button onclick="app.goHome()" class="bg-white text-uga-purple px-10 py-4 rounded-xl font-black shadow-2xl text-xl hover:scale-105 transition border-4 border-white/50">Return to Home</button>
        </div>
    </div>

    <!-- SCREEN: LEADERBOARD -->
    <div id="screen-leaderboard" class="screen flex-col items-center p-6 pt-20">
        <h2 class="text-5xl font-black mb-10 text-white drop-shadow-lg z-10">Scoreboard</h2>
        <div id="leaderboard-list" class="w-full max-w-3xl space-y-4 z-10"></div>
        <button onclick="app.nextQuestionFromLeaderboard()" class="mt-12 bg-white text-uga-purple px-10 py-4 rounded-full font-black shadow-2xl hover:bg-gray-100 hover:scale-105 transition z-10 text-xl">Next Question</button>
    </div>

    <!-- SCREEN: PODIUM -->
    <div id="screen-podium" class="screen items-center justify-end overflow-hidden relative" style="perspective: 1000px;">
        <h1 class="absolute top-16 text-5xl md:text-7xl font-black text-center w-full z-20 text-white drop-shadow-2xl">PODIUM</h1>
        <div class="flex items-end justify-center w-full max-w-4xl h-3/4 pb-20 gap-4 z-10">
            <div class="flex flex-col items-center w-1/3 animate-in slide-in-from-bottom duration-1000 delay-300"><div id="podium-2-avatar" class="text-6xl mb-4 animate-bounce-short drop-shadow-lg">ü§î</div><div id="podium-2-name" class="font-bold mb-2 text-white text-xl bg-black/30 px-4 py-1 rounded-full backdrop-blur">P2</div><div id="podium-2-score" class="text-sm font-bold text-white/90 mb-2">0</div><div class="w-full h-48 bg-gray-300 podium-bar flex items-start justify-center pt-6 font-black text-5xl text-black/40 shadow-2xl border-t-4 border-white/30 rounded-t-lg">2</div></div>
            <div class="flex flex-col items-center w-1/3 z-10 animate-in slide-in-from-bottom duration-1000"><div class="text-7xl absolute -mt-24 text-yellow-300 animate-bounce filter drop-shadow-lg">üëë</div><div id="podium-1-avatar" class="text-8xl mb-4 transform scale-110 drop-shadow-2xl">üòé</div><div id="podium-1-name" class="font-bold text-2xl mb-2 text-yellow-300 bg-black/40 px-6 py-2 rounded-full backdrop-blur">P1</div><div id="podium-1-score" class="text-lg font-bold text-white/90 mb-2">0</div><div class="w-full h-80 bg-yellow-400 podium-bar flex items-start justify-center pt-8 font-black text-7xl text-white shadow-2xl border-t-4 border-white/50 rounded-t-lg ring-4 ring-yellow-200/30">1</div></div>
            <div class="flex flex-col items-center w-1/3 animate-in slide-in-from-bottom duration-1000 delay-500"><div id="podium-3-avatar" class="text-6xl mb-4 animate-bounce-short drop-shadow-lg">ü§°</div><div id="podium-3-name" class="font-bold mb-2 text-white text-xl bg-black/30 px-4 py-1 rounded-full backdrop-blur">P3</div><div id="podium-3-score" class="text-sm font-bold text-white/90 mb-2">0</div><div class="w-full h-32 bg-orange-700 podium-bar flex items-start justify-center pt-6 font-black text-5xl text-black/40 shadow-2xl border-t-4 border-white/30 rounded-t-lg">3</div></div>
        </div>
        <button onclick="app.goHome()" class="mb-12 z-50 bg-white text-black px-8 py-4 rounded-xl font-black hover:bg-gray-100 shadow-2xl hover:scale-105 transition border-4 border-gray-100">Back to Home</button>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        const SoundManager = {
            ctx: null, isHost: false,
            init() {
                if (this.ctx) return;
                try {
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    this.ctx = new AudioContext();
                    ['bgm-menu', 'bgm-game', 'bgm-podium', 'sfx-correct', 'sfx-wrong'].forEach(id => {
                        const el = document.getElementById(id);
                        if(el) { try { this.ctx.createMediaElementSource(el).connect(this.ctx.destination); } catch(e) {} }
                    });
                } catch(e) {}
            },
            resume() { if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume(); },
            play(key) {
                if (!this.isHost) { this.stopAll(); return; }
                this.resume();
                const el = document.getElementById(key); if (!el) return;
                if (key.includes('bgm')) { ['bgm-menu', 'bgm-game', 'bgm-podium'].forEach(k => { if (k !== key) { const o = document.getElementById(k); o.pause(); o.currentTime = 0; } }); el.loop = true; if (key === 'bgm-game') el.playbackRate = 1.0; } else { el.loop = false; el.currentTime = 0; }
                el.play().catch(() => {});
            },
            stopAll() { ['bgm-menu', 'bgm-game', 'bgm-podium'].forEach(id => { const el = document.getElementById(id); el.pause(); el.currentTime = 0; }); },
            setPlaybackRate(rate) { const el = document.getElementById('bgm-game'); if(el) el.playbackRate = rate; }
        };

        const peerConfig = { config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }, { urls: 'stun:global.stun.twilio.com:3478' }] } };

        const app = {
            state: {
                screen: 'home',
                isHost: false,
                quiz: null,
                currentQuestionIndex: 0,
                players: {},
                gamePin: null,
                questionStartTime: 0,
                timerInterval: null,
                editingQuizIndex: null,
                html5QrCode: null,
                transferQuiz: null,
                hostSettings: { showQuestionOnPlayer: false, showAnswersOnPlayer: false },
                currentPlayerProfile: { name: '', avatar: 'üê∂', color: 'bg-red-200' },
                emojiPickerMode: 'join' // 'join' or 'edit'
            },
            peer: null,
            connections: [],

            init() {
                this.generateBackgroundShapes();
                this.generateEmojiGrid();
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const transfer = urlParams.get('transfer');
                if (code) this.showJoinScreen(code);
                if (transfer) { this.showTransferMenu(); this.setupReceiver(transfer); }
                document.body.addEventListener('click', () => { SoundManager.init(); SoundManager.resume(); }, { once: true });
            },

            generateBackgroundShapes() {
                const layer = document.getElementById('shapes-layer'); layer.innerHTML = '';
                const shapes = ['shape-circle', 'shape-square', 'shape-triangle'];
                for(let i=0; i<15; i++) {
                    const div = document.createElement('div');
                    const size = Math.random() * 100 + 50;
                    div.className = `floating-shape ${shapes[Math.floor(Math.random()*shapes.length)]}`;
                    div.style.width = `${size}px`; div.style.height = `${size}px`;
                    div.style.left = `${Math.random() * 100}%`; div.style.top = `${Math.random() * 100}%`;
                    div.style.animationDuration = `${Math.random() * 10 + 10}s`; div.style.animationDelay = `${Math.random() * 5}s`;
                    layer.appendChild(div);
                }
            },
            randomizeShapes() { const shapes = document.querySelectorAll('.floating-shape'); shapes.forEach(s => { s.style.left = `${Math.random() * 100}%`; s.style.top = `${Math.random() * 100}%`; }); },

            generateEmojiGrid() {
                const emojis = ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','üê§','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ü','ü¶ó','üï∑','ü¶Ç','üê¢','üêç','ü¶é','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶ê','ü¶û','ü¶Ä','üê°','üê†','üêü','üê¨','üê≥','üêã','ü¶à','üêä','üêÖ','üêÜ','ü¶ì','ü¶ç','ü¶ß','üêò','ü¶õ','ü¶è','üê™','üê´','ü¶í','ü¶ò','üêÉ','üêÇ','üêÑ','üêé','üêñ','üêë','ü¶ô','üêê','üêï','üê©','ü¶Æ','üêà','üêì','ü¶É','ü¶ö','ü¶ú','ü¶¢','ü¶©','üïä','üêá','ü¶ù','ü¶®','ü¶°','ü¶¶','ü¶•','üêÅ','üêÄ','üêø','ü¶î', 'üí©', 'üëΩ', 'üëª', '‚õÑ', 'ü§ñ', 'üëæ', 'üçô', 'üß∏'];
                const grid = document.getElementById('emoji-grid');
                grid.innerHTML = emojis.map(e => `
                    <div onclick="app.selectEmoji('${e}')" class="text-4xl p-2 cursor-pointer hover:bg-gray-100 rounded flex justify-center items-center">${e}</div>
                `).join('');
            },

            openEmojiPicker(mode) {
                this.state.emojiPickerMode = mode;
                document.getElementById('emoji-modal').classList.remove('hidden');
            },

            selectEmoji(emoji) {
                document.getElementById('emoji-modal').classList.add('hidden');
                if (this.state.emojiPickerMode === 'join') {
                    this.state.currentPlayerProfile.avatar = emoji;
                    document.getElementById('emoji-preview').innerText = emoji;
                } else {
                    // FIX: Update the profile state in edit mode too
                    this.state.currentPlayerProfile.avatar = emoji;
                    document.getElementById('edit-emoji-preview').innerText = emoji;
                }
            },

            // --- NAV ---
            showScreen(id) {
                document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
                document.getElementById('screen-' + id).classList.add('active');
                this.state.screen = id;
                this.randomizeShapes();
                this.triggerScreenMusic(id);
            },
            triggerScreenMusic(id) {
                if (['home','create','library','join','host-lobby','leaderboard','player-wait','transfer'].some(s => id.includes(s))) {
                    if (this.state.isHost) SoundManager.play('bgm-menu'); else SoundManager.stopAll();
                } else if (id.includes('game')) {
                    if (this.state.isHost) SoundManager.play('bgm-game'); else SoundManager.stopAll();
                } else if (id === 'podium') {
                    if (this.state.isHost) SoundManager.play('bgm-podium'); else SoundManager.stopAll();
                } else { SoundManager.stopAll(); }
            },
            goHome() {
                if(this.peer) { this.peer.destroy(); this.peer = null; }
                if(this.state.html5QrCode) this.stopScanner();
                window.location.href = window.location.origin + window.location.pathname;
            },

            // --- HOST UTILS ---
            toggleLargeQr() {
                const modal = document.getElementById('qr-modal');
                const largeQr = document.getElementById('qr-large');
                if (modal.classList.contains('hidden')) {
                    modal.classList.remove('hidden');
                    largeQr.innerHTML = "";
                    const joinUrl = window.location.href.split('?')[0] + '?code=' + this.state.gamePin;
                    new QRCode(largeQr, { text: joinUrl, width: 350, height: 350 });
                } else {
                    modal.classList.add('hidden');
                }
            },

            // --- TRANSFER ---
            showTransferMenu() { this.showScreen('transfer-menu'); },
            setupSender() {
                this.showScreen('transfer-sender');
                const list = document.getElementById('transfer-quiz-list');
                const library = JSON.parse(localStorage.getItem('uga-library') || '[]');
                list.innerHTML = library.length === 0 ? '<p class="text-center p-4 text-gray-500">No quizzes to send!</p>' : library.map((q, idx) => `<div onclick="app.startSendingQuiz(${idx})" class="p-4 border-b hover:bg-gray-100 cursor-pointer flex justify-between items-center transition"><span class="font-bold text-lg">${q.title}</span><span class="text-sm bg-gray-200 px-2 py-1 rounded text-gray-600">${q.questions.length} Qs</span></div>`).join('');
                document.getElementById('sender-status').classList.add('hidden');
            },
            startSendingQuiz(idx) {
                const library = JSON.parse(localStorage.getItem('uga-library') || '[]');
                this.state.transferQuiz = library[idx];
                const transferCode = Math.floor(1000 + Math.random() * 9000).toString();
                const peerId = `uga-transfer-${transferCode}`;
                this.peer = new Peer(peerId, peerConfig);
                this.peer.on('open', () => {
                    document.getElementById('transfer-quiz-list').classList.add('hidden');
                    document.getElementById('sender-status').classList.remove('hidden');
                    document.getElementById('transfer-code-display').innerText = transferCode;
                    document.getElementById('transfer-qrcode').innerHTML = "";
                    const transferUrl = window.location.href.split('?')[0] + '?transfer=' + transferCode;
                    new QRCode(document.getElementById("transfer-qrcode"), { text: transferUrl, width: 200, height: 200 });
                });
                this.peer.on('connection', conn => {
                    conn.on('open', () => {
                        conn.send({ type: 'TRANSFER_DATA', quiz: this.state.transferQuiz });
                        alert("Sent quiz to receiver!"); setTimeout(() => this.goHome(), 1000);
                    });
                });
            },
            setupReceiver(prefillCode = null) { this.showScreen('transfer-receiver'); if(prefillCode) document.getElementById('transfer-code-input').value = prefillCode; },
            startTransferScanner() {
                const html5QrCode = new Html5Qrcode("transfer-reader");
                this.state.html5QrCode = html5QrCode;
                html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                    this.stopScanner(); let code = decodedText; try { const url = new URL(decodedText); code = url.searchParams.get("transfer") || code; } catch(e) {} document.getElementById('transfer-code-input').value = code;
                });
            },
            connectToSender() {
                const code = document.getElementById('transfer-code-input').value; if(code.length !== 4) return alert("Enter 4 digit code");
                this.peer = new Peer(null, peerConfig); 
                this.peer.on('open', () => {
                    const conn = this.peer.connect(`uga-transfer-${code}`);
                    conn.on('open', () => { console.log("Connected to sender"); });
                    conn.on('data', data => { if(data.type === 'TRANSFER_DATA') { this.handleReceivedQuiz(data.quiz); } });
                    setTimeout(() => { if(!conn.open) alert("Connection failed. Sender ready?"); }, 3000);
                });
            },
            handleReceivedQuiz(newQuiz) {
                const library = JSON.parse(localStorage.getItem('uga-library') || '[]');
                const existing = library.find(q => q.title === newQuiz.title);
                if(existing) { if(confirm(`Quiz "${newQuiz.title}" exists. OK to Replace? Cancel to Keep Both.`)) { const idx = library.findIndex(q => q.title === newQuiz.title); library[idx] = newQuiz; } else { newQuiz.title = newQuiz.title + " (Copy)"; library.push(newQuiz); } } else { library.push(newQuiz); }
                localStorage.setItem('uga-library', JSON.stringify(library)); alert("Quiz Received Successfully!"); this.goHome();
            },

            // --- CREATOR ---
            showCreate(editIndex = null) {
                this.showScreen('create');
                this.state.editingQuizIndex = editIndex;
                document.getElementById('questions-container').innerHTML = '';
                if (editIndex !== null) { const lib = JSON.parse(localStorage.getItem('uga-library') || '[]'); const q = lib[editIndex]; document.getElementById('quiz-title-input').value = q.title; q.questions.forEach(qs => this.addQuestionUI(qs)); } else { document.getElementById('quiz-title-input').value = ''; this.addQuestionUI(); }
            },
            handleImageUpload(input, imgPreviewId) {
                const file = input.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const MAX_WIDTH = 600; const scaleSize = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH; canvas.height = img.height * scaleSize;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
                        document.getElementById(imgPreviewId).src = dataUrl;
                        document.getElementById(imgPreviewId).classList.remove('hidden');
                        input.dataset.val = dataUrl; 
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            },
            updateImagePreview(urlInput, imgPreviewId) { const url = urlInput.value; const img = document.getElementById(imgPreviewId); if(url) { img.src = url; img.classList.remove('hidden'); } else { img.classList.add('hidden'); } },
            addQuestionUI(data = null) {
                const container = document.getElementById('questions-container'); const id = Date.now() + Math.random();
                const html = `
                    <div class="glass-panel p-6 rounded-xl shadow-sm relative question-block" id="q-${id}">
                        <div class="flex justify-between mb-4"><span class="font-bold text-gray-500 uppercase tracking-wide">Question</span><button onclick="document.getElementById('q-${id}').remove()" class="text-red-500 font-bold hover:text-red-700 bg-red-100 px-3 py-1 rounded">Delete</button></div>
                        <input type="text" class="q-text w-full p-4 border-2 border-gray-200 rounded-xl mb-4 font-bold text-lg focus:border-uga-purple outline-none" placeholder="Enter your question here..." value="${data ? data.text : ''}">
                        <div class="mb-4 bg-gray-50/80 p-4 rounded-xl border border-gray-100"><label class="block text-sm font-bold text-gray-500 mb-2">Image (URL or Upload)</label><div class="flex gap-2 mb-2"><input type="text" class="q-img-url flex-1 p-2 border rounded-lg text-sm" placeholder="https://..." value="${data && !data.image?.startsWith('data') ? (data.image || '') : ''}" onchange="app.updateImagePreview(this, 'preview-${id}')"><input type="file" accept="image/*" class="w-24 text-sm" onchange="app.handleImageUpload(this, 'preview-${id}')"></div><img id="preview-${id}" src="${data ? (data.image || '') : ''}" class="${data && data.image ? '' : 'hidden'} h-32 object-contain bg-white border rounded-lg mx-auto shadow-sm"><input type="hidden" class="q-img-base64" value="${data && data.image?.startsWith('data') ? data.image : ''}"></div>
                        <div class="flex gap-4 mb-4 items-center"><span class="font-bold text-sm text-gray-600">Time Limit:</span><input type="number" class="q-time w-24 p-2 border-2 rounded-lg font-bold text-center" value="${data ? data.time : 20}"><span class="font-bold text-sm text-gray-600">seconds</span></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">${[0,1,2,3].map(i => `<div class="flex items-center gap-2 p-2 rounded-lg ${['bg-red-50','bg-blue-50','bg-yellow-50','bg-green-50'][i]}"><div class="w-10 h-10 ${['bg-uga-red','bg-uga-blue','bg-uga-yellow','bg-uga-green'][i]} flex items-center justify-center text-white text-sm shadow-md rounded-lg">${['‚ñ≤','‚óÜ','‚óè','‚ñ†'][i]}</div><input type="text" class="q-ans-${i} flex-1 p-2 border border-gray-200 rounded-lg focus:ring-2 ring-${['red','blue','yellow','green'][i]}-200 outline-none" placeholder="Answer ${i+1}" value="${data ? data.answers[i] : ''}"><input type="radio" name="correct-${id}" value="${i}" ${data && data.correct === i ? 'checked' : ''} class="w-6 h-6 accent-uga-green cursor-pointer"></div>`).join('')}</div>
                    </div>`;
                container.insertAdjacentHTML('beforeend', html);
            },
            saveQuiz() {
                const title = document.getElementById('quiz-title-input').value; if(!title) return alert("Title required");
                const questions = [];
                document.querySelectorAll('.question-block').forEach(block => {
                    const text = block.querySelector('.q-text').value;
                    const urlVal = block.querySelector('.q-img-url').value;
                    const fileInput = block.querySelector('input[type="file"]');
                    const base64Val = fileInput.dataset.val || block.querySelector('.q-img-base64').value;
                    const image = base64Val || urlVal; 
                    const time = parseInt(block.querySelector('.q-time').value);
                    const answers = [0,1,2,3].map(i => block.querySelector(`.q-ans-${i}`).value);
                    const radioName = block.querySelector('input[type="radio"]').name;
                    const checked = document.querySelector(`input[name="${radioName}"]:checked`);
                    if(text && answers[0] && answers[1] && checked) { questions.push({ text, image, time, answers, correct: parseInt(checked.value) }); }
                });
                if(questions.length === 0) return alert("Need 1+ valid question");
                const lib = JSON.parse(localStorage.getItem('uga-library') || '[]');
                const data = { id: Date.now(), title, questions };
                if (this.state.editingQuizIndex !== null) lib[this.state.editingQuizIndex] = data; else lib.push(data);
                try { localStorage.setItem('uga-library', JSON.stringify(lib)); this.showLibrary(); } catch(e) { alert("Storage full! Use smaller images."); }
            },

            // --- LIBRARY ---
            showLibrary() {
                this.showScreen('library');
                const list = document.getElementById('library-list');
                const lib = JSON.parse(localStorage.getItem('uga-library') || '[]');
                list.innerHTML = lib.length === 0 ? `<div class="col-span-3 text-center p-8 glass-panel rounded-xl"><p class="text-xl font-bold text-gray-500">No quizzes found.</p><p class="text-gray-400">Create one to get started!</p></div>` : lib.map((q, idx) => `
                    <div class="glass-panel p-6 rounded-xl shadow hover:shadow-xl transition border-l-8 border-uga-purple group flex flex-col relative overflow-hidden">
                        <div class="absolute right-0 top-0 p-2 opacity-10 text-6xl group-hover:scale-110 transition">üìù</div>
                        <h3 class="font-black text-2xl mb-2 text-uga-purple truncate z-10">${q.title}</h3>
                        <p class="text-gray-500 font-bold text-sm mb-6 bg-gray-100 inline-block px-2 py-1 rounded w-max z-10">${q.questions.length} Questions</p>
                        <div class="flex gap-2 mt-auto z-10">
                            <button onclick="app.hostGame(${q.id})" class="flex-1 bg-uga-blue text-white py-2 rounded-lg font-bold hover:bg-blue-700 shadow-md">Play</button>
                            <button onclick="app.duplicateQuiz(${idx})" class="bg-yellow-100 text-yellow-600 px-3 rounded-lg font-bold hover:bg-yellow-200" title="Duplicate">‚ùê</button>
                            <button onclick="app.showCreate(${idx})" class="bg-gray-200 text-gray-700 px-3 rounded-lg font-bold hover:bg-gray-300">Edit</button>
                            <button onclick="app.deleteQuiz(${idx})" class="bg-red-100 text-red-500 px-3 rounded-lg font-bold hover:bg-red-200">‚úï</button>
                        </div>
                    </div>
                `).join('');
            },
            duplicateQuiz(idx) { const lib = JSON.parse(localStorage.getItem('uga-library') || '[]'); const copy = JSON.parse(JSON.stringify(lib[idx])); copy.id = Date.now(); copy.title += " (Copy)"; lib.push(copy); localStorage.setItem('uga-library', JSON.stringify(lib)); this.showLibrary(); },
            deleteQuiz(index) { if(!confirm("Delete?")) return; const lib = JSON.parse(localStorage.getItem('uga-library') || '[]'); lib.splice(index, 1); localStorage.setItem('uga-library', JSON.stringify(lib)); this.showLibrary(); },

            // --- HOST ---
            hostGame(quizId) {
                const lib = JSON.parse(localStorage.getItem('uga-library') || '[]');
                this.state.quiz = lib.find(q => q.id === quizId);
                this.state.isHost = true;
                SoundManager.isHost = true; SoundManager.init(); SoundManager.resume();
                this.state.players = {};
                this.state.gamePin = Math.floor(100000 + Math.random() * 900000).toString();
                this.state.currentQuestionIndex = 0;
                this.showScreen('host-lobby');
                document.getElementById('game-pin-display').innerText = this.state.gamePin;
                document.getElementById('footer-pin').innerText = this.state.gamePin;
                document.getElementById('host-url-display').innerText = window.location.host;
                document.getElementById('qrcode').innerHTML = "";
                const joinUrl = window.location.href.split('?')[0] + '?code=' + this.state.gamePin;
                new QRCode(document.getElementById("qrcode"), { text: joinUrl, width: 250, height: 250 });
                this.peer = new Peer(`uga-fun-${this.state.gamePin}`, peerConfig);
                this.peer.on('connection', conn => {
                    this.connections.push(conn);
                    conn.on('data', data => this.handleHostData(data, conn));
                    conn.on('close', () => { if(this.state.players[conn.peer]) { delete this.state.players[conn.peer]; this.updateHostLobbyUI(); }});
                });
            },
            handleHostData(data, conn) { 
                if(data.type === 'JOIN') { 
                    this.state.players[conn.peer] = { id: conn.peer, conn, name: data.name, avatar: data.avatar, color: data.color, score: 0, streak: 0, lastAnswer: null }; 
                    this.updateHostLobbyUI(); 
                    
                    // LATE JOINER FIX
                    if (this.state.screen === 'game-host') {
                        const q = this.state.quiz.questions[this.state.currentQuestionIndex];
                        const safeQ = {
                            text: this.state.hostSettings.showQuestionOnPlayer ? q.text : null,
                            image: this.state.hostSettings.showQuestionOnPlayer ? q.image : null,
                            time: q.time,
                            answers: this.state.hostSettings.showAnswersOnPlayer ? q.answers : null,
                            index: this.state.currentQuestionIndex,
                            count: this.state.quiz.questions.length
                        };
                        conn.send({ type: 'QUESTION_START', payload: safeQ });
                    }
                } 
                else if (data.type === 'ANSWER') this.handlePlayerAnswer(conn.peer, data);
                else if (data.type === 'UPDATE_PROFILE') {
                    if (this.state.players[conn.peer]) {
                        this.state.players[conn.peer].name = data.name;
                        this.state.players[conn.peer].avatar = data.avatar;
                        this.state.players[conn.peer].color = data.color;
                        this.updateHostLobbyUI();
                    }
                }
            },
            updateHostLobbyUI() { const players = Object.values(this.state.players); document.getElementById('player-count').innerText = `${players.length} Players`; const btn = document.getElementById('start-btn'); btn.disabled = players.length === 0; btn.classList.toggle('opacity-50', players.length === 0); document.getElementById('host-player-grid').innerHTML = players.map(p => `<div class="glass-panel p-2 rounded-lg flex items-center gap-3 animate-in fade-in zoom-in"><div class="w-10 h-10 ${p.color} rounded-full flex items-center justify-center text-xl shadow-md border-2 border-white">${p.avatar}</div><span class="font-bold truncate text-gray-800">${p.name}</span></div>`).join(''); },
            startHostedGame() {
                this.state.hostSettings.showQuestionOnPlayer = document.getElementById('setting-show-q').checked;
                this.state.hostSettings.showAnswersOnPlayer = document.getElementById('setting-show-a').checked;
                this.broadcast({ type: 'GAME_START' });
                this.startRound();
            },
            startRound() {
                const q = this.state.quiz.questions[this.state.currentQuestionIndex];
                Object.values(this.state.players).forEach(p => p.lastAnswer = null);
                this.showScreen('game-host');
                document.getElementById('footer-pin-game').innerText = this.state.gamePin;
                document.getElementById('host-q-index').innerText = `${this.state.currentQuestionIndex + 1} / ${this.state.quiz.questions.length}`;
                document.getElementById('host-q-text').innerText = q.text;
                document.getElementById('host-answers-count').innerText = "0 Answers";
                document.getElementById('host-timer-circle').innerText = q.time;
                document.getElementById('host-next-btn').classList.add('hidden');
                
                // Reset Stats UI
                [0,1,2,3].forEach(i => {
                    document.getElementById(`stat-bar-${i}`).style.height = '0%';
                    document.getElementById(`stat-text-${i}`).classList.add('hidden');
                    document.getElementById(`h-opt-${i}`).style.opacity = '1';
                });

                const imgContainer = document.getElementById('host-q-image-container');
                if(q.image) { document.getElementById('host-q-image').src = q.image; imgContainer.classList.remove('hidden'); } else imgContainer.classList.add('hidden');
                q.answers.forEach((ans, idx) => { const el = document.getElementById(`h-opt-${idx}`); el.querySelector('.opt-text').innerText = ans; el.style.visibility = ans ? 'visible' : 'hidden'; });
                const safeQ = {
                    text: this.state.hostSettings.showQuestionOnPlayer ? q.text : null,
                    image: this.state.hostSettings.showQuestionOnPlayer ? q.image : null,
                    time: q.time,
                    answers: this.state.hostSettings.showAnswersOnPlayer ? q.answers : null,
                    index: this.state.currentQuestionIndex, count: this.state.quiz.questions.length
                };
                this.broadcast({ type: 'QUESTION_START', payload: safeQ });
                let timeLeft = q.time;
                this.state.questionStartTime = Date.now();
                SoundManager.play('bgm-game');
                clearInterval(this.state.timerInterval);
                this.state.timerInterval = setInterval(() => {
                    timeLeft--; document.getElementById('host-timer-circle').innerText = timeLeft;
                    if(timeLeft > 0 && (q.time - timeLeft) / q.time > 0.5) SoundManager.setPlaybackRate(1 + ((q.time - timeLeft) / q.time - 0.5));
                    if(timeLeft <= 0) this.endRound();
                }, 1000);
            },
            handlePlayerAnswer(peerId, data) {
                const p = this.state.players[peerId];
                if(p.lastAnswer) return; p.lastAnswer = data;
                const count = Object.values(this.state.players).filter(pl => pl.lastAnswer).length;
                document.getElementById('host-answers-count').innerText = `${count} Answers`;
                if(count === Object.keys(this.state.players).length) this.endRound();
            },
            endRound() {
                clearInterval(this.state.timerInterval);
                SoundManager.setPlaybackRate(1.0);
                const q = this.state.quiz.questions[this.state.currentQuestionIndex];
                const answers = Object.values(this.state.players).map(p => p.lastAnswer ? p.lastAnswer.index : -1);
                const totalVotes = answers.filter(a => a !== -1).length;
                
                // Show Stats
                [0,1,2,3].forEach(i => {
                    const count = answers.filter(a => a === i).length;
                    const percent = totalVotes === 0 ? 0 : Math.round((count / totalVotes) * 100);
                    
                    document.getElementById(`stat-bar-${i}`).style.height = percent + '%';
                    document.getElementById(`stat-percent-${i}`).innerText = percent + '%';
                    document.getElementById(`stat-count-${i}`).innerText = count + ' votes';
                    document.getElementById(`stat-text-${i}`).classList.remove('hidden');
                    
                    if(i !== q.correct) document.getElementById(`h-opt-${i}`).style.opacity = '0.4';
                });

                Object.values(this.state.players).forEach(p => {
                    let corr = false, pts = 0;
                    if(p.lastAnswer) {
                        if(p.lastAnswer.index === q.correct) { corr = true; p.streak++; pts = Math.round(1000 * (1 - Math.min(p.lastAnswer.timeTaken / (q.time * 1000), 1) / 2)); p.score += pts; }
                        else p.streak = 0;
                    } else p.streak = 0;
                    p.conn.send({ type: 'ROUND_RESULT', payload: { correct: corr, scoreEarned: pts, score: p.score, streak: p.streak } });
                });
                
                const btn = document.getElementById('host-next-btn');
                btn.innerText = (this.state.currentQuestionIndex < this.state.quiz.questions.length - 1) ? "Next" : "Podium";
                btn.classList.remove('hidden');
                btn.onclick = () => this.showLeaderboard();
            },
            showLeaderboard() {
                this.showScreen('leaderboard');
                const sorted = Object.values(this.state.players).sort((a,b) => b.score - a.score);
                document.getElementById('leaderboard-list').innerHTML = sorted.slice(0,5).map((p,i) => `<div class="glass-panel p-4 rounded-xl flex justify-between items-center shadow-lg transform transition hover:scale-105 border-l-4 border-white/50"><div class="flex items-center gap-4"><span class="font-black text-3xl w-10 text-uga-purple/50">#${i+1}</span><div class="w-12 h-12 ${p.color} rounded-full flex items-center justify-center border-2 border-white text-2xl shadow-md">${p.avatar}</div><span class="font-bold text-2xl text-uga-dark">${p.name}</span></div><span class="font-black text-2xl text-uga-purple">${p.score}</span></div>`).join('');
            },
            nextQuestionFromLeaderboard() { this.state.currentQuestionIndex++; if(this.state.currentQuestionIndex < this.state.quiz.questions.length) this.startRound(); else this.showPodium(); },
            showPodium() {
                this.showScreen('podium');
                const sorted = Object.values(this.state.players).sort((a,b) => b.score - a.score);
                [0,1,2].forEach(i => { const p = sorted[i]; const r = i+1; document.getElementById(`podium-${r}-name`).innerText = p ? p.name : '-'; document.getElementById(`podium-${r}-score`).innerText = p ? p.score : ''; document.getElementById(`podium-${r}-avatar`).innerText = p ? p.avatar : ''; });
                Object.values(this.state.players).forEach(p => { const rank = sorted.indexOf(p) + 1; p.conn.send({ type: 'GAME_OVER', payload: { rank } }); });
                const end = Date.now() + 3000; (function frame() { confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } }); confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } }); if (Date.now() < end) requestAnimationFrame(frame); }());
            },
            broadcast(msg) { this.connections.forEach(c => c.send(msg)); },

            // --- PLAYER ---
            showJoinScreen(code = '') { this.state.isHost = false; SoundManager.isHost = false; SoundManager.stopAll(); this.showScreen('join'); if(code) document.getElementById('pin-input').value = code; },
            startScanner() {
                document.getElementById('scanner-container').classList.remove('hidden');
                this.state.html5QrCode = new Html5Qrcode("reader");
                this.state.html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                    const url = new URL(decodedText); const code = url.searchParams.get("code");
                    if(code) { this.stopScanner(); document.getElementById('pin-input').value = code; this.validatePin(); }
                }, () => {});
            },
            stopScanner() { if(this.state.html5QrCode) { this.state.html5QrCode.stop().then(() => { document.getElementById('scanner-container').classList.add('hidden'); document.getElementById('reader').innerHTML = ""; }); } },
            validatePin() { const pin = document.getElementById('pin-input').value; if(pin.length !== 6) return alert("6 digit PIN required"); document.getElementById('join-step-1').classList.add('hidden'); document.getElementById('join-step-2').classList.remove('hidden'); this.updateAvatarUI(); },
            setJoinColor(color) { this.state.currentPlayerProfile.color = color; this.updateAvatarUI(); },
            setEditColor(color) { this.state.currentPlayerProfile.color = color; document.getElementById('edit-emoji-preview').className = `w-24 h-24 rounded-full flex items-center justify-center text-5xl ${color} shadow-inner border-4 border-gray-100 cursor-pointer hover:scale-105 transition`; },
            updateAvatarUI() { const el = document.getElementById('emoji-preview'); el.innerText = this.state.currentPlayerProfile.avatar; el.className = `w-24 h-24 rounded-full flex items-center justify-center text-5xl ${this.state.currentPlayerProfile.color} shadow-inner border-4 border-white cursor-pointer hover:scale-105 transition relative`; },
            
            joinLobby() {
                const btn = document.getElementById('join-lobby-btn'); btn.disabled = true; btn.innerText = "Connecting...";
                const nick = document.getElementById('nickname-input').value; const pin = document.getElementById('pin-input').value;
                if(!nick) { btn.disabled = false; btn.innerText = "READY!"; return alert("Name required"); }
                
                this.state.currentPlayerProfile.name = nick;
                this.peer = new Peer(null, peerConfig); 
                this.peer.on('open', () => {
                    const conn = this.peer.connect(`uga-fun-${pin}`);
                    conn.on('open', () => { 
                        this.state.hostConn = conn; 
                        conn.send({ type: 'JOIN', name: nick, avatar: this.state.currentPlayerProfile.avatar, color: this.state.currentPlayerProfile.color }); 
                        this.showScreen('player-wait'); 
                        this.updateWaitScreenProfile();
                    });
                    conn.on('data', data => this.handlePlayerData(data));
                    setTimeout(() => { if(!conn.open) { alert("Connect failed."); btn.disabled = false; btn.innerText = "READY!"; } }, 5000);
                });
            },

            updateWaitScreenProfile() {
                document.getElementById('wait-name-display').innerText = this.state.currentPlayerProfile.name;
                const avatarEl = document.getElementById('wait-avatar-display');
                avatarEl.innerText = this.state.currentPlayerProfile.avatar;
                avatarEl.className = `w-24 h-24 rounded-full flex items-center justify-center text-5xl mb-3 shadow-lg ${this.state.currentPlayerProfile.color}`;
            },

            openEditProfile() {
                document.getElementById('edit-nick-input').value = this.state.currentPlayerProfile.name;
                document.getElementById('edit-emoji-preview').innerText = this.state.currentPlayerProfile.avatar;
                this.setEditColor(this.state.currentPlayerProfile.color);
                document.getElementById('edit-profile-modal').classList.remove('hidden');
            },

            saveProfileChanges() {
                const newName = document.getElementById('edit-nick-input').value;
                if(!newName) return alert("Name required");
                this.state.currentPlayerProfile.name = newName;
                // Avatar and Color are already in state from picker interaction
                
                this.updateWaitScreenProfile();
                document.getElementById('edit-profile-modal').classList.add('hidden');
                
                // Send update to host
                if(this.state.hostConn) {
                    this.state.hostConn.send({
                        type: 'UPDATE_PROFILE',
                        name: this.state.currentPlayerProfile.name,
                        avatar: this.state.currentPlayerProfile.avatar,
                        color: this.state.currentPlayerProfile.color
                    });
                }
            },

            handlePlayerData(data) {
                if(data.type === 'GAME_START') { this.showScreen('game-player'); document.getElementById('player-view-wait').classList.remove('hidden'); document.getElementById('player-view-options').classList.add('hidden'); document.getElementById('player-view-content').classList.add('hidden'); }
                else if (data.type === 'QUESTION_START') {
                    document.getElementById('player-view-wait').classList.add('hidden'); document.getElementById('player-view-result').classList.add('hidden'); document.getElementById('player-view-options').classList.remove('hidden');
                    const contentDiv = document.getElementById('player-view-content');
                    if(data.payload.text || data.payload.image) { contentDiv.classList.remove('hidden'); document.getElementById('player-q-text').innerText = data.payload.text || ""; const img = document.getElementById('player-q-image'); if(data.payload.image) { img.src = data.payload.image; img.classList.remove('hidden'); } else img.classList.add('hidden'); } else contentDiv.classList.add('hidden');
                    [0,1,2,3].forEach(i => { const btn = document.getElementById(`p-btn-${i}`); btn.classList.remove('hidden'); btn.disabled = false; btn.style.opacity = '1'; const txt = btn.querySelector('.p-opt-text'); if(data.payload.answers && data.payload.answers[i]) { txt.innerText = data.payload.answers[i]; txt.classList.remove('hidden'); } else { if(data.payload.answers) btn.classList.add('hidden'); else txt.classList.add('hidden'); } });
                    this.state.currentQuestionStartTime = Date.now();
                } else if (data.type === 'ROUND_RESULT') {
                    const resDiv = document.getElementById('player-view-result');
                    document.getElementById('player-view-options').classList.add('hidden'); document.getElementById('player-view-content').classList.add('hidden');
                    resDiv.className = "fixed inset-0 z-50 flex-col items-center justify-center text-white p-4 flex " + (data.payload.correct ? "bg-uga-green/90" : "bg-uga-red/90");
                    document.getElementById('p-res-title').innerText = data.payload.correct ? "CORRECT" : "INCORRECT"; document.getElementById('p-res-score').innerText = (data.payload.correct ? "+" : "") + data.payload.scoreEarned; document.getElementById('p-res-streak').innerText = "Streak: " + data.payload.streak;
                } else if (data.type === 'GAME_OVER') {
                    document.getElementById('player-view-result').classList.add('hidden'); document.getElementById('player-game-over').classList.remove('hidden'); document.getElementById('p-final-rank').innerText = `You placed #${data.payload.rank}`;
                }
            },
            submitAnswer(index) {
                const btns = document.querySelectorAll('#player-view-options button'); btns.forEach((b, i) => { b.disabled = true; if(i !== index) b.style.opacity = '0.3'; });
                this.state.hostConn.send({ type: 'ANSWER', index, timeTaken: Date.now() - this.state.currentQuestionStartTime });
                document.getElementById('player-view-wait').classList.remove('hidden'); document.getElementById('player-view-options').classList.add('hidden'); document.getElementById('player-view-content').classList.add('hidden'); document.getElementById('player-view-wait').querySelector('h1').innerText = "Answer Sent!";
            }
        };
        app.init();
    </script>
</body>
</html>
